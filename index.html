<!DOCTYPE html>
<html>
<head>
    <title>Land Use Map - Madrid</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Add Proj4Leaflet for coordinate transformation -->
    <script src="https://unpkg.com/proj4@2.8.0/dist/proj4.js"></script>
    <script src="https://unpkg.com/proj4leaflet@1.0.2/src/proj4leaflet.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        #map { 
            height: 100vh; 
            width: 100vw; 
        }
        .legend { 
            background: white; 
            padding: 15px; 
            border: 2px solid grey; 
            border-radius: 8px;
            position: fixed; 
            bottom: 20px; 
            left: 20px; 
            max-height: 50vh;
            overflow-y: auto; 
            z-index: 1000; 
            font-size: 13px;
            min-width: 220px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .legend-item { 
            margin: 3px 0; 
            display: flex; 
            align-items: center; 
        }
        .legend-color { 
            width: 16px; 
            height: 16px; 
            margin-right: 10px; 
            border: 1px solid #ccc; 
            flex-shrink: 0;
        }
        .legend-text { 
            word-wrap: break-word; 
            line-height: 1.3;
        }
        .loading-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1001;
            font-size: 14px;
            display: none;
        }
        .chunk-info {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 5px;
            z-index: 1001;
            font-size: 12px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="legend">
        <b>HILUCS Categories</b>
        <div id="legend-items"></div>
    </div>
    <div class="loading-indicator" id="loading">Loading chunks...</div>
    <div class="chunk-info" id="chunk-info">Loaded: 0/0 chunks</div>

    <script>
        const colorMap = {
            "AbandonedAreas": "#1f77b4",
            "Agriculture": "#aec7e8",
            "AquacultureAndFishing": "#ff7f0e",
            "CommercialServices": "#ffbb78",
            "CommunityServices": "#2ca02c",
            "CulturalEntertainmentAndRecreationalServices": "#98df8a",
            "Forestry": "#d62728",
            "LandAreasNotInOtherEconomicUse": "#ff9896",
            "MiningAndQuarrying": "#9467bd",
            "NotKnownUse": "#c5b0d5",
            "ResidentialUse": "#8c564b",
            "SecondaryProduction": "#c49c94",
            "TransitionalAreas": "#e377c2",
            "TransportNetworks": "#f7b6d2",
            "Utilities": "#7f7f7f",
            "WaterAreasNotInOtherEconomicUse": "#c7c7c7"
        };

        // Define coordinate transformation (UTM Zone 30N to WGS84)
        proj4.defs("EPSG:25830", "+proj=utm +zone=30 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");

        // Initialize map centered on Madrid
        const MADRID_CENTER = [40.4168, -3.7038];
        const map = L.map('map').setView(MADRID_CENTER, 10);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // Chunk management
        const loadedChunks = new Set();
        const chunkLayers = new Map();
        let isLoading = false;
        let loadQueue = [];

        // Generate all chunk URLs
        const chunkUrls = [];
        for (let i = 0; i < 90; i++) {
            chunkUrls.push(`https://bhaskar-02.github.io/land-used-maps-2/land_use_chunk_${i}.geojson`);
        }

        // Transform coordinates function
        function transformCoordinates(coordinates) {
            if (coordinates[0] instanceof Array) {
                return coordinates.map(transformCoordinates);
            } else {
                const [x, y] = coordinates;
                const [lng, lat] = proj4("EPSG:25830", "EPSG:4326", [x, y]);
                return [lng, lat];
            }
        }

        // Style function
        function getStyle(feature) {
            const category = feature.properties.HILUCS_DESC;
            const color = colorMap[category] || '#999999';
            return {
                fillColor: color,
                color: 'black',
                weight: 0.5,
                fillOpacity: 0.7,
                opacity: 1
            };
        }

        // Update UI indicators
        function updateChunkInfo() {
            document.getElementById('chunk-info').innerHTML = 
                `Loaded: ${loadedChunks.size}/${chunkUrls.length} chunks`;
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Load a single chunk
        async function loadChunk(url, index) {
            if (loadedChunks.has(index) || isLoading) {
                return;
            }

            console.log(`Loading chunk ${index + 1}/${chunkUrls.length}`);
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    // Transform coordinates for each feature
                    data.features.forEach(feature => {
                        if (feature.geometry.type === 'Polygon') {
                            feature.geometry.coordinates = transformCoordinates(feature.geometry.coordinates);
                        } else if (feature.geometry.type === 'MultiPolygon') {
                            feature.geometry.coordinates = transformCoordinates(feature.geometry.coordinates);
                        }
                    });

                    const geoJsonLayer = L.geoJSON(data, {
                        style: getStyle,
                        onEachFeature: function(feature, layer) {
                            const category = feature.properties.HILUCS_DESC || 'Unknown';
                            layer.bindTooltip(`<b>HILUCS:</b> ${category}`, {
                                sticky: true,
                                direction: 'top'
                            });
                        }
                    });

                    geoJsonLayer.addTo(map);
                    chunkLayers.set(index, geoJsonLayer);
                    loadedChunks.add(index);
                    
                    console.log(`Chunk ${index + 1} loaded: ${data.features.length} features`);
                }
            } catch (error) {
                console.error(`Error loading chunk ${index}:`, error);
            }
            
            updateChunkInfo();
        }

        // Load chunks in batches based on priority
        async function loadChunksBatch(chunkIndices, batchSize = 3) {
            if (isLoading) return;
            
            isLoading = true;
            showLoading();
            
            // Process in batches to avoid overwhelming the browser
            for (let i = 0; i < chunkIndices.length; i += batchSize) {
                const batch = chunkIndices.slice(i, i + batchSize);
                const promises = batch
                    .filter(index => !loadedChunks.has(index))
                    .map(index => loadChunk(chunkUrls[index], index));
                
                await Promise.all(promises);
                
                // Small delay between batches to keep UI responsive
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            isLoading = false;
            hideLoading();
        }

        // Determine which chunks to load based on map view and zoom
        function getRelevantChunks() {
            const zoom = map.getZoom();
            const bounds = map.getBounds();
            
            // Load more chunks at higher zoom levels
            let chunksToLoad;
            if (zoom >= 12) {
                // High zoom: load chunks that intersect current view
                chunksToLoad = getChunksInBounds(bounds);
            } else if (zoom >= 10) {
                // Medium zoom: load subset of chunks
                chunksToLoad = Array.from({length: 30}, (_, i) => i);
            } else {
                // Low zoom: load only a few representative chunks
                chunksToLoad = Array.from({length: 10}, (_, i) => i * 9);
            }
            
            return chunksToLoad;
        }

        // Simplified bounds checking (you can enhance this based on your data's geographic extent)
        function getChunksInBounds(bounds) {
            // Since we don't know exact chunk bounds, load progressively
            // This is a simplified approach - you could enhance this with actual chunk bounds
            const totalChunks = chunkUrls.length;
            const maxChunks = Math.min(40, totalChunks);
            return Array.from({length: maxChunks}, (_, i) => i);
        }

        // Load initial chunks
        function loadInitialChunks() {
            const initialChunks = getRelevantChunks();
            loadChunksBatch(initialChunks);
        }

        // Event listeners for dynamic loading
        map.on('zoomend', function() {
            const newChunks = getRelevantChunks();
            const unloadedChunks = newChunks.filter(i => !loadedChunks.has(i));
            
            if (unloadedChunks.length > 0) {
                loadChunksBatch(unloadedChunks);
            }
        });

        map.on('moveend', function() {
            const zoom = map.getZoom();
            if (zoom >= 11) { // Only load on move at higher zoom levels
                const newChunks = getRelevantChunks();
                const unloadedChunks = newChunks.filter(i => !loadedChunks.has(i));
                
                if (unloadedChunks.length > 0 && unloadedChunks.length <= 10) {
                    loadChunksBatch(unloadedChunks, 2); // Smaller batches for move events
                }
            }
        });

        // Generate legend
        function generateLegend() {
            const legendItems = document.getElementById('legend-items');
            Object.entries(colorMap).forEach(([category, color]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${color};"></div>
                    <div class="legend-text">${category}</div>
                `;
                legendItems.appendChild(item);
            });
        }

        // Initialize everything
        generateLegend();
        updateChunkInfo();

        // Start loading chunks after a short delay to let the map initialize
        setTimeout(() => {
            loadInitialChunks();
        }, 500);

        console.log('Map initialized. Dynamic chunk loading enabled.');
        console.log(`Total chunks available: ${chunkUrls.length}`);
    </script>
</body>
</html>
